<!DOCTYPE html>

<html lang="en">

  <head>

    <meta charset="utf-8">

    <title>midibus.js</title>

    <meta name="description" content="Web MIDI API wrapper based on themidibus">

    <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0,minimal-ui">

    <style>
      body {
        margin: 30px;
        font-family: sans-serif;
        font-weight: 200;
        font-size: 20px;
      }
      a {
        text-decoration: none;
      }
      h1 {
        font-weight: inherit;
        font-size: 2em;
      }
      h2 {
        font-weight: inherit;
        font-size: inherit;
        border-bottom: 1px solid #ccc;
        padding-bottom: 50px;
        margin-bottom: 50px;
      }
    </style>

  </head>

  <body>

    <main>
      <h1>midibus.js</h1>
    </main>

    <script src="midibus.umd.js"></script>

    <script>
      var main = document.getElementsByTagName('main')[0]
      function log(msg) {
        var p = document.createElement('p')
        p.innerHTML = msg
        main.appendChild(p)
      }
      midibus.access(function () {
        log('Access granted<br><br>')

        //Accessing the JSON file and logs a simple test
        var xhReq = new XMLHttpRequest();
        xhReq.open("GET", "./midiTest.json", false);
        xhReq.send(null);
        var jsonOutput = JSON.parse(xhReq.responseText);
        console.log("test: " + jsonOutput.tracks[0].notes[0].midi);

        let inputsLog = 'inputs: '
        midibus.inputs.forEach((el, i) => { inputsLog += el.name + (midibus.inputs[i+1] ? ', ' : '') })
        log(inputsLog)

        let outputsLog = 'outputs: '
        midibus.inputs.forEach((el, i) => { outputsLog += el.name + (midibus.outputs[i+1] ? ', ' : '') })
        log(outputsLog + '<br><br>')

        var bus = midibus.bus(midibus.inputs[0], midibus.outputs[0])

        //Loop plays all notes from the JSON file
        for (var i = 0; i < 16; i++) {
            console.log("pre: " + i); //For testing
            
            window.setTimeout(function () {
            console.log("[" + i + "]" + jsonOutput.tracks[0].notes[i].midi);
            bus.send('noteOff', midibus.message(0, jsonOutput.tracks[0].notes[i].midi, 128*(jsonOutput.tracks[0].notes[i].velocity) -1))
            }, jsonOutput.tracks[0].notes[i].time*1000)

            var bus = midibus.bus(midibus.inputs[0], midibus.outputs[0])
            window.setTimeout(function () {
            bus.send('noteOn', midibus.message(0, jsonOutput.tracks[0].notes[i].midi, 128*(jsonOutput.tracks[0].notes[i].velocity) -1))
            }, jsonOutput.tracks[0].notes[i].duration*1000 + jsonOutput.tracks[0].notes[i].time*1000)
        }

        //Destroys the bus after 10 seconds
        window.setTimeout(function () {
          log('<br>Destroying the bus')
          bus.destroy()
        }, 10000)
      })
    </script>

  </body>

</html>